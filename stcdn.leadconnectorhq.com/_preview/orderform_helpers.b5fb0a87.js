import{B as m,x as Q,Y as D}from"./entry.7aa2e1a5.js";import{A as R,b as rr,C as H}from"./HLConst.414de9c2.js";import{U as V,W as Y,k as er,at as J,an as W,V as j,w as G,am as C,a9 as k,u as $,N as tr,G as ir,P as nr,Q as ar,O as sr,R as or}from"./constants.fdd6dcf3.js";import{F as ur}from"./FunnelServices.02f21e86.js";import{f as K}from"./funnel_event_helper.f5b0341a.js";const wr={base:{color:"#32325d",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"#aab7c4"}},invalid:{color:"#fa755a",iconColor:"#fa755a"}},vr=(r,e,t)=>{let o=[];return{updatedProducts:r.map(n=>{if(n._id===t._id){if(e>n.max)return n.qty=n.qty,o.push(`A maximum of ${n.max} units of ${n.name} only can be purchased`),n;if(e>n.price.availableQuantity&&n.price.trackInventory&&!n.price.allowOutOfStockPurchases)return n.qty=n.qty,o.push(`Only ${n.price.availableQuantity} units of ${n.name} are in stock`),n;n.qty=e}return n}),errorMessages:o}},_r=r=>{var e,t,o;return((e=r==null?void 0:r.price)==null?void 0:e.availableQuantity)<=0&&((t=r==null?void 0:r.price)==null?void 0:t.trackInventory)&&!((o=r==null?void 0:r.price)!=null&&o.allowOutOfStockPurchases)},br=(r,e)=>e.find(t=>t._id===r.id),lr=async({contactId:r,domain:e,pageUrl:t,locationId:o,productPreviewList:u,isCouponApplied:n,couponCode:i,couponSessionId:a,store:f,subType:c,traceId:h="",reCaptchaToken:s,isEcommercePurchase:y,shippingRateId:l,toZip:E,toState:O,toCountry:P,shippingCarrierRateId:T,note:w})=>{var v,_,g,M;try{const I=m("msgsndr_id").value,L=m("am_id").value,U=m("am_fingerprint").value,N=f.funnelName||"funnel";e||(e=window.location.hostname,t=window.location.pathname);const{funnelPageId:x,funnelId:q,stepId:A}=f,F={altId:o,altType:"location",shippingRateId:l,shippingCarrierRateId:T,contactId:r,source:{type:f.pageType===C.FUNNEL?C.FUNNEL:C.WEBSITE,subType:c,id:q,name:N,meta:{stepId:A,pageId:x,domain:e,pageUrl:t,affiliateManager:{id:L,fingerprint:U}}},products:u.map(b=>({id:y?b.selectedPrice._id:b._id,qty:b.qty||b.quantity})),fingerprint:I,trackingId:J(),traceId:h,toZip:E,toState:O,toCountry:P,customerNote:w};n&&(F.couponCode=i,F.couponSessionId=a),s&&(F.captchaToken=s);const S=await k.createOrder(F);if(!((v=S.order)==null?void 0:v._id))throw new Error("Something went wrong while creating order. Please try again later.");return S}catch(I){return console.error(I),{error:!0,message:(g=(_=I==null?void 0:I.response)==null?void 0:_._data)==null?void 0:g.message,status:(M=I==null?void 0:I.response)==null?void 0:M.status}}},dr=async(r,e,t,o,u,n)=>{var z,b,B;const i=m("msgsndr_id").value,a=m("am_id").value,f=m("am_fingerprint").value,c=tr(r.locationId),h=ir(r.locationId),s=nr(),y=r.funnelName||"funnel";let{domain:l,page_url:E}=e.query;l||(l=window.location.hostname,E=window.location.pathname);const{funnelPageId:O,funnelId:P,stepId:T}=r,w={eventType:"optin",domainName:l,pageUrl:E,funnelId:P,pageId:O,stepId:T},{address:v,country:_,state:g,city:M,zipcode:I,fullName:L,phoneNumber:U,emailId:N,companyName:x}=t,q={addressLine1:v,country:_||o,state:g,city:M,zip:I};s.medium=ar.OrderForm,s.mediumId=w.stepId;const A=sr();s.fbEventId=A;const F={lead:!0,eventData:s,source:y,pageId:O,funnelId:P,sessionId:c,funnelEventData:w,sessionFingerprint:h||null},S={locationId:r.locationId,name:L,phone:U,email:(N==null?void 0:N.toLowerCase())||"",companyName:x,address:q,attribution:F,timezone:or(),amId:String(a),amFingerprint:f,orderFormType:"one_step_form_submission",captchaToken:u};n.enableStickyContact&&(S.attribution.fingerprint=i,S.attribution.funnelEventData.fingerprint=i),n.enableForceCreate&&(S.attribution.forceCreate=!0),n.enableEmailValidation&&(S.attribution.session_d=Number(n.enableEmailValidation)||0);try{const d=await ur.createContact(S);if(!d)throw new Error("Something went wrong. Please try again later.");if(d.fbEventId=A,i!==d.fingerprint){r.fingerprint=i;const p=m("msgsndr_id",{path:"/",maxAge:31536e3});p.value=d.fingerprint}J();const X=j(d);G("_ud",X),Q(()=>{K("track","SubmitApplication")});let Z=d.sessionFingerprint;return s&&(V({sessionId:d.sessionId||null,locationId:r.locationId}),Z&&Y(r.locationId,Z)),d}catch(d){return console.error(d),{error:!0,message:(b=(z=d==null?void 0:d.response)==null?void 0:z._data)==null?void 0:b.message,status:(B=d==null?void 0:d.response)==null?void 0:B.status}}},Er=async(r,e,t,o,u,n,i,a,f,c,h,s,y,l,E,O,P,T)=>{var w,v,_;if((!i||!i.id)&&(i=await dr(r,e,t,o,u,n),u=void 0),i!=null&&i.error){let g={};return(i==null?void 0:i.status)===429?(g={error:!0,processingPayment:!1,showRecaptcha:!0},g):(g={error:!0,processingPayment:!1,cardErrorMsg:i.message||"We're sorry, but something went wrong. Please try again"},g)}if((i.id&&!a||!((w=a==null?void 0:a.order)!=null&&w._id))&&(a=await lr({contactId:i==null?void 0:i.id,domain:r.domain,pageUrl:r.pageUrl,locationId:r.locationId,productPreviewList:c,isCouponApplied:f,couponCode:s,couponSessionId:h,store:r,subType:l,traceId:i==null?void 0:i.traceId,reCaptchaToken:u,isEcommercePurchase:y,shippingRateId:E,toZip:(t==null?void 0:t.zipcode)??((v=t.address)==null?void 0:v.zip),toState:O,toCountry:(t==null?void 0:t.country)??((_=t.address)==null?void 0:_.country),shippingCarrierRateId:P,note:T}),u=void 0),a!=null&&a.error){let g={};return a.status===429?(g={error:!0,processingPayment:!1,showRecaptcha:!0,contactResponse:i},g):(g={error:!0,processingPayment:!1,contactResponse:i,cardErrorMsg:a.message||"We're sorry, but something went wrong. Please try again"},g)}return(a==null?void 0:a.success)===!1?{error:!0,cardErrorMsg:a==null?void 0:a.message,processingPayment:!1}:(sessionStorage.setItem("orderResponse",JSON.stringify(a)),l!=W.TWO_STEP_ORDER_FORM&&sessionStorage.setItem("contactResponse",JSON.stringify(i)),sessionStorage.setItem("orderResponse",JSON.stringify(a)),l!=W.TWO_STEP_ORDER_FORM&&sessionStorage.setItem("contactResponse",JSON.stringify(i)),sessionStorage.setItem("orderResponse",JSON.stringify(a)),l!=W.TWO_STEP_ORDER_FORM&&sessionStorage.setItem("contactResponse",JSON.stringify(i)),{contactResponse:i,orderResponse:a,reCaptchaToken:u})},gr=(r,e,t,o)=>{if(J()!=(t==null?void 0:t.verifiedTrackingId)){const n=m("tr",{path:"/",maxAge:900});n.value=t==null?void 0:t.verifiedTrackingId}if(o!==W.TWO_STEP_ORDER_FORM){if(r.fingerprint!==e){const i=m("msgsndr_id",{path:"/",maxAge:31536e3});i.value=r.fingerprint}const n=j(r);G("_ud",n)}if(r.fbEventId){let n=r.fbEventId;Q(()=>{K("track","OrderFormPurchase",n)})}else console.warn("Facebook event Id missing from attribution!")},Or=async(r,e,t,o,u)=>{let n=!1,i="";if(e!=null&&e.message&&!(e!=null&&e.success))throw new Error(e.message);t===R&&(e!=null&&e.pendingConfirmation)&&(n=!0,i="Order placed successfully! However your transaction is pending for review. Please contact the business owner");const a=m("msgsndr_id").value;await gr(r,a,e,u);const f=m("provider");f.value=t===rr?"pp":t===H?H:"cc",await mr({sessionId:r.sessionId,sessionFingerprint:e==null?void 0:e.sessionFingerprint},o);const c=sessionStorage.getItem("redirect");if(fr(o),c){sessionStorage.removeItem("redirect"),window.location.href=c;return}return{paymentResponseData:e,authorizeOrderPendingConfirmation:n,authorizeOrderAlertMsg:i}},mr=(r,e)=>{r&&r.sessionId&&(V({sessionId:r.sessionId||null,locationId:e}),r.sessionFingerprint&&Y(e,r.sessionFingerprint))},Pr=r=>{var t;(!(r.keyCode>=48&&r.keyCode<=57||r.keyCode>=96&&r.keyCode<=105)||!/^\d{0,2}$/.test((t=r.target)==null?void 0:t.value))&&r.keyCode!==8&&r.preventDefault()},fr=r=>{const e=er();return sessionStorage.setItem(`couponSessionId_${r}`,e),e},Fr=async(r,e,t="",o,u,n)=>{var i,a,f,c,h;try{const s=$(),y={altId:s.value.locationId,altType:"location",couponCode:t,source:{type:s.value.pageType===C.FUNNEL?C.FUNNEL:C.WEBSITE,subType:e,id:s.value.funnelId,name:s.value.funnelName,meta:{stepId:s.value.stepId,pageId:s.value.funnelPageId,domain:s.value.domain,pageUrl:s.value.pageUrl,affiliateManager:{id:m("am_id").value,fingerprint:m("msgsndr_id").value}}},products:r,toCountry:o,toState:u,toZip:n},l=await k.getAmountSummary(y);return{total:l.summary.total,subtotal:l.summary.subtotal,taxSummary:l.summary.taxSummary,subtotalWithDiscount:l.summary.subtotalWithDiscount,futureRecurringPaymentAmount:(i=l.recurringSummary)==null?void 0:i.subtotalWithDiscount}}catch(s){return console.error(s),{error:!0,message:((f=(a=s==null?void 0:s.response)==null?void 0:a._data)==null?void 0:f.message)||"Something went wrong while fetching order total. Please try again later",status:(h=(c=s==null?void 0:s.response)==null?void 0:c._data)==null?void 0:h.status}}},Cr=async(r,e)=>{const t=await k.getLastPaymentMethodForTheCustomer({altId:r,altType:"location",contactId:e});return{paymentProvider:t==null?void 0:t.paymentProvider,paymentMethod:t==null?void 0:t.paymentMethod}},Tr=async(r,e)=>await k.getLastSquarePaymentMethodForTheCustomer({altId:r,altType:"location",contactId:e}),Nr=(r,e,t,o)=>{const u=e<=0&&!t,n=t&&o<=0,i=u||n;return!!(r&&i||i)},kr=async()=>{const r=$();try{const e=await k.getStatesInformation();if(e&&e.error)throw D(e.error);r.value.countryList=(e==null?void 0:e.data)??[]}catch(e){console.error("Failed to fetch country list",e)}},Mr=r=>$().value.countryList.find(t=>t.code===r),Ar=(r,e,t)=>{if(r.startsWith("+44")&&e.match(/^07\d*$/)){const o=r.replace("+44 1534","+44").replace("1534","");return window.libphonenumber.parsePhoneNumberFromString(o,"JE").formatInternational()}return t.formatInternational()};export{Mr as a,Tr as b,lr as c,Fr as d,Ar as e,Cr as f,kr as g,Or as h,fr as i,_r as j,br as k,vr as l,Er as m,Pr as n,Nr as p,wr as s};
